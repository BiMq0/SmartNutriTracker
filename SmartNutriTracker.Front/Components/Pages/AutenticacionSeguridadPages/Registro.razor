@page "/gestion-usuarios"
@using SmartNutriTracker.Shared.DTOs.Usuarios
@inject SmartNutriTracker.Front.Services.AuthService AuthService
@inject NavigationManager NavigationManager

<div class="contenedor">
    <div class="col-izq">
        <h2 class="titulo">Registrarse</h2>

        <EditForm Model="@NuevoUsuario" OnValidSubmit="OnSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <label>Nombre de Usuario</label>
            <InputText @bind-Value="NuevoUsuario.Username" class="form-control" />

            <label>Contraseña</label>
            <InputText type="password" @bind-Value="Password" class="form-control" />

            <label>Confirmar Contraseña</label>
            <InputText type="password" @bind-Value="ConfirmPassword" class="form-control" />

            <label>Rol</label>
            <InputSelect @bind-Value="NuevoUsuario.RolId" class="form-control">
                <option value="1">Administrador</option>
                <option value="2">Docente</option>
                <option value="3">Nutricionista</option>
                <option value="4">Estudiante</option>
            </InputSelect>

            <button type="submit" class="btn-naranja" disabled="@Enviando">
                @(Enviando ? "Registrando..." : "Registrarse")
            </button>

            @if (!string.IsNullOrEmpty(Message))
            {
                <div style="margin-top: 10px; color:@(Success ? "green" : "red")">
                    @Message
                </div>
            }
        </EditForm>
</div>
</div>
@code {
    private UsuarioNuevoDTO NuevoUsuario = new UsuarioNuevoDTO();
    private string Password { get; set; } = string.Empty;
    private string ConfirmPassword { get; set; } = string.Empty;

    private string Message { get; set; } = string.Empty;
    private bool Success { get; set; } = false;
    private bool Enviando = false;

    private async Task OnSubmit()
    {
        Enviando = true;
        Message = "";
        Success = false;

        // Limpiar espacios
        string pass = Password.Trim();
        string confirm = ConfirmPassword.Trim();

        if (pass != confirm)
        {
            Message = "Las contraseñas no coinciden.";
            Enviando = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(NuevoUsuario.Username) || string.IsNullOrWhiteSpace(pass))
        {
            Message = "Usuario y contraseña son obligatorios.";
            Enviando = false;
            return;
        }

        // Asignar la contraseña ya limpia al DTO
        NuevoUsuario.Password = pass;

        var response = await AuthService.RegisterAsync(NuevoUsuario);

        if (response != null && response.Usuario != null)
        {
            Success = true;
            Message = "Usuario registrado correctamente.";
            await Task.Delay(1000);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            Message = response?.Mensaje ?? "Error al registrar el usuario.";
        }

        Enviando = false;
    }
}
