@page "/login" 
@using SmartNutriTracker.Shared.DTOs.Usuarios
@using SmartNutriTracker.Front.Services 
@inject AuthService AuthService 
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<div class="login-container">

    <div class="login-image">
        <img src="\Images\mujer-saltando-cuerda-elementos-estilo-vida-saludable_18591-71803-removebg-preview.png" alt="Imagen Login">
    </div>

    <div class="login-form">
        <div class="login-title">INICIA SESIÓN</div>

        @if (!string.IsNullOrEmpty(mensajeError))
        {
            <div class="advertencia-message">
                <strong>❌ Error:</strong> @mensajeError
            </div>
        }

        @if (!string.IsNullOrEmpty(mensajeExito))
        {
            <div class="exito-message">
                <strong>✓ Éxito:</strong> @mensajeExito
            </div>
        }

<EditForm Model="@loginModel" OnValidSubmit="IniciarSesion">
            <InputText class="form-control" @bind-Value="loginModel.Username" placeholder="Usuario" />
            <InputText type="password" class="form-control" @bind-Value="loginModel.Password" placeholder="Contraseña" />
            <button type="submit" class="btn-login" disabled="@enviando">
                @(enviando ? "Iniciando..." : "Iniciar Sesión")
    </button>
</EditForm>
    </div>

</div>

@code {
    private LoginDTO loginModel = new LoginDTO();
    private bool enviando = false;
    private string mensajeError = string.Empty;
    private string mensajeExito = string.Empty;

    private async Task IniciarSesion()
    {
        enviando = true;
        mensajeError = string.Empty;
        mensajeExito = string.Empty;

        if (string.IsNullOrWhiteSpace(loginModel.Username) || string.IsNullOrWhiteSpace(loginModel.Password))
        {
            mensajeError = "Usuario y contraseña son obligatorios.";
            enviando = false;
            return;
        }

        var resultado = await AuthService.LoginAsync(loginModel);

        if (resultado == null)
        {
            mensajeError = "Credenciales incorrectas o error en el servidor.";
            enviando = false;
            return;
        }

        mensajeExito = resultado.Mensaje ?? "Inicio de sesión exitoso.";
        await Task.Delay(1000);
        NavigationManager.NavigateTo("/"); // redirige al home/dashboard
        enviando = false;
    }
}
