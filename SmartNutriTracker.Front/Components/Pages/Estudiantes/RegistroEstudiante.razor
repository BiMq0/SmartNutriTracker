@page "/registro-estudiante"
@using SmartNutriTracker.Shared.DTOs.Estudiantes
@using SmartNutriTracker.Domain.Statics
@using SmartNutriTracker.Front.Services
@inject EstudianteService EstudianteService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<style>
    .btn-primary-custom {
        background-color: #576E40;
        border-color: #576E40;
        color: #F1EAC0;
    }
    .btn-primary-custom:hover {
        background-color: #BCD09F;
        border-color: #BCD09F;
        color: #221C04;
    }
    .card-custom {
        border-color: #BCD09F;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card-header-custom {
        background-color: #576E40;
        color: #F1EAC0;
    }
    .form-control:focus {
        border-color: #576E40;
        box-shadow: 0 0 0 0.2rem rgba(87, 110, 64, 0.25);
    }
    .form-label {
        color: #221C04;
        font-weight: 600;
    }
    .alert-success-custom {
        background-color: #BCD09F;
        border-color: #576E40;
        color: #221C04;
    }
    .alert-danger-custom {
        background-color: #F8D7DA;
        border-color: #C2854C;
        color: #8B4513;
    }
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card card-custom">
                <div class="card-header card-header-custom">
                    <h4 class="mb-0">Registro de Estudiante</h4>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Message))
                    {
                        <div class="alert @(Success ? "alert-success-custom" : "alert-danger-custom") mb-3">
                            @Message
                        </div>
                    }

                    <EditForm Model="@NuevoEstudiante" OnSubmit="OnSubmit" FormName="RegistroEstudianteForm">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">Nombre Completo *</label>
                            <InputText @bind-Value="NuevoEstudiante.NombreCompleto" class="form-control" placeholder="Ej: Juan Pérez" />
                            <ValidationMessage For="@(() => NuevoEstudiante.NombreCompleto)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Fecha de Nacimiento *</label>
                            <InputDate @bind-Value="NuevoEstudiante.FechaNacimiento" class="form-control" />
                            <ValidationMessage For="@(() => NuevoEstudiante.FechaNacimiento)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Sexo *</label>
                            <InputSelect @bind-Value="NuevoEstudiante.Sexo" class="form-control">
                                <option value="@Sexo.Varon">Varón</option>
                                <option value="@Sexo.Mujer">Mujer</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => NuevoEstudiante.Sexo)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Peso (kg) *</label>
                            <InputNumber @bind-Value="NuevoEstudiante.Peso" class="form-control" step="0.1" placeholder="Ej: 65.5" />
                            <ValidationMessage For="@(() => NuevoEstudiante.Peso)" class="text-danger small" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Altura (m) *</label>
                            <InputNumber @bind-Value="NuevoEstudiante.Altura" class="form-control" step="0.01" placeholder="Ej: 1.65" />
                            <ValidationMessage For="@(() => NuevoEstudiante.Altura)" class="text-danger small" />
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-primary-custom btn-lg py-3" disabled="@Enviando">
                                @(Enviando ? "Registrando..." : "Registrar Estudiante")
                            </button>
                        </div>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private EstudianteRegistroDTO NuevoEstudiante = new();
    private string Message = string.Empty;
    private bool Success = false;
    private bool Enviando = false;

    protected override void OnInitialized()
    {
        // Valores por defecto
        NuevoEstudiante.FechaNacimiento = new DateTime(2005, 1, 1);
        NuevoEstudiante.Sexo = Sexo.Varon;
        NuevoEstudiante.Peso = 60;
        NuevoEstudiante.Altura = 1.65m;
    }

    private async Task OnSubmit()
    {
        Enviando = true;
        Message = "";
        Success = false;

        var response = await EstudianteService.RegistrarEstudianteAsync(NuevoEstudiante);

        if (response != null && response.Estudiante != null)
        {
            Success = true;
            Message = "Estudiante registrado correctamente.";
            await Task.Delay(1000);
            Navigation.NavigateTo("/dashboard");
        }
        else
        {
            Message = response?.Mensaje ?? "Error al registrar el estudiante.";
        }

        Enviando = false;
    }
}
