@page "/menus"
@using SmartNutriTracker.Shared.DTOs.Menus
@using SmartNutriTracker.Shared.DTOs.Alimentos
@inject HttpClient Http
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<div class="page-wrapper">
    
    <header class="app-header">
        <div class="header-band-top"></div>
        <div class="header-band-main">
            <h1 class="header-title">
                <span class="icon-emoji">üçΩÔ∏è</span> Seguimiento de Men√∫s
            </h1>
            <p class="header-subtitle">Revisa tus planes de alimentaci√≥n diarios con detalles nutricionales.</p>
        </div>
        <div class="header-band-bottom"></div>
    </header>

    <main class="menus-main-content">
        <div class="page-header-section">
            <h3 class="page-title">Historial de Men√∫s</h3>
            <a href="/menus/crear" class="btn-add-menu">
                <span class="btn-icon">‚ûï</span> Crear Men√∫ Diario
            </a>
        </div>

        @if (menus == null)
        {
            <p class="loading-text">Cargando datos de men√∫s...</p>
        }
        else
        {
            <div class="accordion" id="menusAccordion">
                @if (!menus.Any())
                {
                    <p class="no-data-text">No se encontraron men√∫s para mostrar. <a href="/menus/crear">Crea tu primer men√∫</a></p>
                }
                else
                {
                    @foreach (var menu in menus)
                    {
                        var targetId = $"collapse_{menu.MenuId}";
                        var controlsId = $"heading_{menu.MenuId}";
                        
                        var totalCalorias = menu.Alimentos?.Sum(a => a.Calorias) ?? 0;
                        var totalProteinas = menu.Alimentos?.Sum(a => a.Proteinas) ?? 0;
                        var totalCarbohidratos = menu.Alimentos?.Sum(a => a.Carbohidratos) ?? 0;
                        var totalGrasas = menu.Alimentos?.Sum(a => a.Grasas) ?? 0;
                        var cantidadAlimentos = menu.Alimentos?.Count ?? 0;
                        
                        <div class="menu-card">
                            <div class="menu-card-header" id="@controlsId">
                                <button class="menu-toggle-button collapsed" 
                                        type="button" 
                                        @onclick="@(() => ToggleMenu(targetId))">
                                    <div class="menu-info">
                                        <div class="menu-title-line">
                                            <span class="menu-date">üìÖ @menu.Fecha.ToString("dddd, dd MMMM yyyy")</span>
                                        </div>
                                        <div class="menu-meta-line">
                                            <span class="menu-alimentos-count">üçé @cantidadAlimentos alimento@(cantidadAlimentos != 1 ? "s" : "")</span>
                                            <span class="menu-separator">‚Ä¢</span>
                                            <span class="menu-calorias">üî• @totalCalorias kcal</span>
                                        </div>
                                    </div>
                                    <span class="expand-icon @(menusExpandidos.Contains(targetId) ? "rotated" : "")">‚ñº</span>
                                </button>
                            </div>

                            @if (menusExpandidos.Contains(targetId))
                            {
                                <div class="menu-card-body">
                                    <h6 class="alimentos-heading">üç¥ Alimentos del Men√∫:</h6>
                                    
                                    <table class="table alimentos-detail-table">
                                        <thead>
                                            <tr>
                                                <th>Alimento</th>
                                                <th class="text-end">Cal.</th>
                                                <th class="text-end">Prot. (g)</th>
                                                <th class="text-end">Carb. (g)</th>
                                                <th class="text-end">Grasas (g)</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (menu.Alimentos != null && menu.Alimentos.Any())
                                            {
                                                @foreach (var alimento in menu.Alimentos)
                                                {
                                                    <tr>
                                                        <td><strong>@alimento.Nombre</strong></td>
                                                        <td class="text-end">@alimento.Calorias</td>
                                                        <td class="text-end">@alimento.Proteinas</td>
                                                        <td class="text-end">@alimento.Carbohidratos</td>
                                                        <td class="text-end">@alimento.Grasas</td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr><td colspan="5" class="text-center no-alimentos">Men√∫ sin alimentos registrados.</td></tr>
                                            }
                                        </tbody>
                                    </table>
                                    
                                    <div class="menu-summary">
                                        <p class="summary-title">üìä Totales del D√≠a:</p>
                                        <div class="summary-details">
                                            <span>Calor√≠as: <span class="summary-value">@totalCalorias kcal</span></span>
                                            <span>Prote√≠nas: <span class="summary-value">@totalProteinas g</span></span>
                                            <span>Carbs: <span class="summary-value">@totalCarbohidratos g</span></span>
                                            <span>Grasas: <span class="summary-value">@totalGrasas g</span></span>
                                        </div>
                                    </div>

                                    <div class="menu-actions">
                                        <button class="btn-delete-menu" @onclick="@(() => MostrarModalEliminar(menu))">
                                            üóëÔ∏è Eliminar Men√∫
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        }
    </main>

    <!-- Modal de confirmaci√≥n de eliminaci√≥n -->
    @if (mostrarModal && menuAEliminar != null)
    {
        <div class="modal-overlay" @onclick="CerrarModal">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h4>‚ö†Ô∏è Confirmar Eliminaci√≥n</h4>
                </div>
                <div class="modal-body">
                    <p>¬øEst√°s seguro de que deseas eliminar el men√∫ del <strong>@menuAEliminar.Fecha.ToShortDateString()</strong>?</p>
                    <p class="modal-warning">Esta acci√≥n no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-modal-cancel" @onclick="CerrarModal">Cancelar</button>
                    <button class="btn-modal-confirm" @onclick="ConfirmarEliminar">Eliminar</button>
                </div>
            </div>
        </div>
    }

    <footer class="app-footer">
        <div class="footer-band-top"></div>
        <div class="footer-band-main">
            <p>Creado con <span class="footer-icon">üå±</span> para mejorar tu bienestar.</p>
        </div>
        <div class="footer-band-bottom">
            <p>¬© SmartNutriTracker</p>
        </div>
    </footer>
</div>

@code {
    private List<MenuDTO>? menus;
    private HashSet<string> menusExpandidos = new();
    private bool mostrarModal = false;
    private MenuDTO? menuAEliminar;

    protected override async Task OnInitializedAsync()
    {
        await CargarMenus();
    }

    private async Task CargarMenus()
    {
        try
        {
            menus = await Http.GetFromJsonAsync<List<MenuDTO>>("https://localhost:7187/api/menus/GetAll");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar men√∫s: {ex.Message}");
            menus = new List<MenuDTO>(); 
        }
    }

    private void ToggleMenu(string menuId)
    {
        if (menusExpandidos.Contains(menuId))
        {
            menusExpandidos.Remove(menuId);
        }
        else
        {
            menusExpandidos.Add(menuId);
        }
    }

    private void MostrarModalEliminar(MenuDTO menu)
    {
        menuAEliminar = menu;
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
        menuAEliminar = null;
    }

    private async Task ConfirmarEliminar()
    {
        if (menuAEliminar == null) return;

        try
        {
            var response = await Http.DeleteAsync($"https://localhost:7187/api/menus/Delete/{menuAEliminar.MenuId}");
            if (response.IsSuccessStatusCode)
            {
                Console.WriteLine($"‚úì Men√∫ {menuAEliminar.MenuId} eliminado correctamente");
                await CargarMenus();
            }
            else
            {
                Console.WriteLine($"Error al eliminar men√∫ {menuAEliminar.MenuId}: {response.ReasonPhrase}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Excepci√≥n al eliminar men√∫ {menuAEliminar.MenuId}: {ex.Message}");
        }
        finally
        {
            CerrarModal();
        }
    }
}

<style>
    /* VARIABLES DE COLOR */
    :root {
        --color-light-green: #BCD09F;
        --color-dark-green: #576E40;
        --color-dark-brown: #221C04;
        --color-orange-brown: #C2854C;
        --color-cream: #F1EAC0;
        --color-grey-dark: #3c3c3c;
    }
    
    /* ---------------------------------------------------- */
    /* GENERAL LAYOUT Y CONTENIDO PRINCIPAL */
    /* ---------------------------------------------------- */

    .page-wrapper {
        background-color: var(--color-cream);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    .menus-main-content {
        flex-grow: 1;
        padding: 2rem;
    }

    /* ---------------------------------------------------- */
    /* HEADER CON BOT√ìN */
    /* ---------------------------------------------------- */

    .page-header-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .page-title {
        color: var(--color-dark-brown);
        font-weight: 600;
        border-bottom: 3px solid var(--color-light-green);
        padding-bottom: 0.5rem;
        margin: 0;
    }

    .btn-add-menu {
        background-color: var(--color-dark-green);
        color: var(--color-cream);
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .btn-add-menu:hover {
        background-color: var(--color-dark-brown);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn-icon {
        font-size: 1.2em;
    }

    .loading-text, .no-data-text {
        color: var(--color-orange-brown);
        font-size: 1.1rem;
        font-style: italic;
        text-align: center;
        padding: 2rem;
    }

    .no-data-text a {
        color: var(--color-dark-green);
        text-decoration: underline;
        font-weight: 600;
    }

    /* ---------------------------------------------------- */
    /* HEADER */
    /* ---------------------------------------------------- */

    .app-header {
        width: 100%;
    }

    .header-band-top {
        height: 10px;
        background-color: var(--color-grey-dark);
    }
    
    .header-band-main {
        background-color: var(--color-dark-green);
        padding: 1.5rem 2rem;
        text-align: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .header-title {
        color: var(--color-cream);
        font-weight: 700;
        margin: 0;
        font-size: 2.2rem;
        text-shadow: 1px 1px 2px var(--color-dark-brown);
    }
    
    .header-subtitle {
        color: var(--color-light-green);
        margin: 0.25rem 0 0;
        font-size: 1.1rem;
    }

    .icon-emoji {
        font-size: 1.5em;
        vertical-align: middle;
        margin-right: 0.5rem;
    }

    .header-band-bottom {
        height: 10px;
        background-color: var(--color-orange-brown);
    }

    /* ---------------------------------------------------- */
    /* DISE√ëO DE MEN√öS (Acorde√≥n) */
    /* ---------------------------------------------------- */

    .menu-card {
        margin-bottom: 15px;
        border-radius: 8px;
        border: 1px solid var(--color-light-green);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        background-color: #ffffff;
    }
    
    .menu-card-header {
        background-color: var(--color-light-green); 
        padding: 0;
        border-radius: 8px 8px 0 0;
    }

    .menu-toggle-button {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 1rem 1.5rem;
        text-align: left;
        color: var(--color-dark-brown);
        font-weight: 600;
        font-size: 1.1rem;
        background: none;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .menu-toggle-button .menu-info {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
        flex: 1;
    }

    .menu-title-line {
        font-size: 1.1rem;
        font-weight: 700;
    }

    .menu-date {
        color: var(--color-dark-brown);
    }

    .menu-meta-line {
        font-size: 0.9rem;
        color: var(--color-dark-green);
        display: flex;
        gap: 0.75rem;
        align-items: center;
    }

    .menu-alimentos-count {
        font-weight: 600;
    }

    .menu-separator {
        color: var(--color-orange-brown);
    }

    .menu-calorias {
        font-weight: 700;
        color: var(--color-orange-brown);
    }

    .menu-toggle-button:hover {
        background-color: #adc791;
    }

    .expand-icon {
        transition: transform 0.3s ease;
        color: var(--color-dark-green);
        font-size: 1.1rem;
    }

    .expand-icon.rotated {
        transform: rotate(-180deg);
    }

    /* Cuerpo del Acorde√≥n */
    .menu-card-body {
        padding: 1.5rem;
        background-color: #ffffff;
        border-radius: 0 0 8px 8px;
    }

    .alimentos-heading {
        color: var(--color-dark-green);
        border-bottom: 2px dashed var(--color-cream);
        padding-bottom: 0.5rem;
        margin-bottom: 0.75rem;
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    /* Tabla de Detalles Nutricionales */
    .alimentos-detail-table {
        margin-bottom: 1.5rem;
        width: 100%;
        border-collapse: collapse;
    }
    
    .alimentos-detail-table th {
        background-color: var(--color-dark-green);
        color: var(--color-cream);
        padding: 0.75rem 0.5rem;
        font-size: 0.85rem;
        text-transform: uppercase;
        font-weight: 600;
    }
    
    .alimentos-detail-table tbody tr:nth-child(even) {
        background-color: var(--color-cream);
    }
    
    .alimentos-detail-table tbody td {
        padding: 0.5rem 0.5rem;
        border-bottom: 1px solid var(--color-light-green);
        color: var(--color-dark-brown);
        font-size: 0.95rem;
    }

    .alimentos-detail-table tbody td strong {
        color: var(--color-orange-brown);
    }
    
    .no-alimentos {
        font-style: italic;
        color: #888;
    }

    /* Resumen de Totales del D√≠a */
    .menu-summary {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid var(--color-orange-brown);
    }

    .summary-title {
        font-weight: 700;
        color: var(--color-dark-green);
        margin: 0 0 0.5rem 0;
    }
    
    .summary-details {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
    }
    
    .summary-details span {
        font-size: 0.95rem;
        color: var(--color-dark-brown);
    }
    
    .summary-value {
        color: var(--color-orange-brown);
        font-weight: 800;
    }

    /* Acciones del men√∫ */
    .menu-actions {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
    }

    .btn-delete-menu {
        background-color: var(--color-orange-brown);
        color: var(--color-cream);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-delete-menu:hover {
        background-color: var(--color-dark-brown);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* ---------------------------------------------------- */
    /* MODAL */
    /* ---------------------------------------------------- */

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeIn 0.2s ease;
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        animation: slideDown 0.3s ease;
    }

    @@keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        background-color: var(--color-dark-green);
        color: var(--color-cream);
        padding: 1.5rem;
        border-radius: 8px 8px 0 0;
    }

    .modal-header h4 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .modal-body {
        padding: 2rem 1.5rem;
        color: var(--color-dark-brown);
    }

    .modal-body p {
        margin: 0 0 1rem 0;
        font-size: 1rem;
    }

    .modal-body strong {
        color: var(--color-orange-brown);
        font-weight: 700;
    }

    .modal-warning {
        color: #d32f2f;
        font-size: 0.9rem;
        font-style: italic;
    }

    .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
    }

    .btn-modal-cancel,
    .btn-modal-confirm {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-modal-cancel {
        background-color: #e0e0e0;
        color: var(--color-dark-brown);
    }

    .btn-modal-cancel:hover {
        background-color: #d0d0d0;
    }

    .btn-modal-confirm {
        background-color: #d32f2f;
        color: white;
    }

    .btn-modal-confirm:hover {
        background-color: #b71c1c;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
    }

    /* ---------------------------------------------------- */
    /* FOOTER */
    /* ---------------------------------------------------- */

    .app-footer {
        width: 100%;
        margin-top: auto;
    }
    
    .footer-band-top {
        height: 10px;
        background-color: var(--color-orange-brown);
    }

    .footer-band-main {
        background-color: var(--color-light-green);
        padding: 1.5rem 2rem;
        text-align: center;
    }
    
    .footer-band-main p {
        color: var(--color-dark-brown);
        margin: 0;
        font-size: 1rem;
    }

    .footer-icon {
        font-size: 1.2em;
    }

    .footer-band-bottom {
        background-color: var(--color-grey-dark);
        padding: 0.5rem 2rem;
        text-align: right;
    }

    .footer-band-bottom p {
        color: #aaaaaa;
        margin: 0;
        font-size: 0.8rem;
    }
</style>