@page "/alimentos/registrar/{estudianteId:int}"
@page "/alimentos/registrar"
@rendermode InteractiveServer
@using SmartNutriTracker.Shared.DTOs.Alimentos
@using SmartNutriTracker.Front.Services 
@using System.Text.Json
@inject RegistroAlimentoService RegistroAlimentoService
@inject AlimentosService AlimentoService
@inject TipoComidaService TipoComidaService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header header-custom">
            <h3 class="mb-0">üçé Registrar lo que comiste</h3>
            <p class="mb-0" style="opacity: 0.9; font-size: 0.9rem;">Completa la informaci√≥n de lo que consumiste hoy</p>
        </div>
        
        <div class="card-body">
            @if (isLoadingCatalogos)
            {
                <div class="text-center py-4">
                    <div class="spinner-border" style="color: var(--color-accent);" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2" style="color: var(--color-secondary);">Cargando opciones...</p>
                </div>
            }
            else
            {
                <EditForm Model="@nuevoRegistro" OnValidSubmit="@RegistrarConsumo" FormName="RegistroAlimentoForm">
                    <div class="mb-4">
                        <div class="alert alert-info-custom">
                            <div class="d-flex align-items-center">
                                <div style="font-size: 1.5rem; margin-right: 0.5rem;">üìÖ</div>
                                <div>
                                    <strong>Registro del d√≠a @DateTime.Now.ToString("dd/MM/yyyy")</strong><br/>
                                    <small>Hora actual: @DateTime.Now.ToString("HH:mm")</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4 mb-3" style="color: var(--color-secondary);">
                        <span style="font-size: 1.5rem;">üçΩÔ∏è</span> ¬øQu√© comiste?
                    </h5>
                    
                    @if (nuevoRegistro.AlimentosConsumidos.Count == 0)
                    {
                        <div class="alert-empty mb-4">
                            <div class="text-center py-4">
                                <div style="font-size: 3rem; opacity: 0.3;">üçé</div>
                                <p style="color: var(--color-secondary);">Comienza agregando el primer alimento que consumiste</p>
                            </div>
                        </div>
                    }
                    
                    @for (int i = 0; i < nuevoRegistro.AlimentosConsumidos.Count; i++)
                    {
                        var index = i;
                        <div class="card card-alimento mb-3">
                            <div class="card-header card-header-alimento">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span style="font-weight: 600;">Comida #@(index + 1)</span>
                                        <small style="color: var(--color-secondary); margin-left: 0.5rem;">
                                            @GetTipoComidaNombre(nuevoRegistro.AlimentosConsumidos[index].TipoComidaId)
                                        </small>
                                    </div>
                                    @if (nuevoRegistro.AlimentosConsumidos.Count > 1)
                                    {
                                        <button type="button" class="btn btn-sm btn-danger-custom" 
                                                @onclick="() => EliminarAlimento(index)"
                                                title="Eliminar esta comida">
                                            üóëÔ∏è
                                        </button>
                                    }
                                </div>
                            </div>
                            
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label form-label-custom">¬øQu√© alimento fue? *</label>
                                            <InputSelect class="form-select form-select-custom" 
                                                       @bind-Value="nuevoRegistro.AlimentosConsumidos[index].AlimentoId">
                                                <option value="0">-- Selecciona un alimento --</option>
                                                @foreach (var alimento in alimentos)
                                                {
                                                    <option value="@alimento.AlimentoId">
                                                        @alimento.Nombre (@alimento.Calorias kcal)
                                                    </option>
                                                }
                                            </InputSelect>
                                            @if (errors.ContainsKey($"Alimento_{index}"))
                                            {
                                                <small class="text-danger">@errors[$"Alimento_{index}"]</small>
                                            }
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label form-label-custom">¬øEn qu√© comida? *</label>
                                            <InputSelect class="form-select form-select-custom" 
                                                       @bind-Value="nuevoRegistro.AlimentosConsumidos[index].TipoComidaId">
                                                <option value="0">-- Selecciona --</option>
                                                @foreach (var tipo in tiposComida)
                                                {
                                                    <option value="@tipo.TipoComidaId">@tipo.Nombre</option>
                                                }
                                            </InputSelect>
                                            @if (errors.ContainsKey($"TipoComida_{index}"))
                                            {
                                                <small class="text-danger">@errors[$"TipoComida_{index}"]</small>
                                            }
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label form-label-custom">¬øCu√°nto comiste? (gramos) *</label>
                                            <InputNumber min="1" class="form-control form-control-custom" 
                                                       @bind-Value="nuevoRegistro.AlimentosConsumidos[index].Cantidad"
                                                       placeholder="Ej: 100" />
                                            @if (errors.ContainsKey($"Cantidad_{index}"))
                                            {
                                                <small class="text-danger">@errors[$"Cantidad_{index}"]</small>
                                            }
                                            <small style="color: var(--color-secondary); opacity: 0.8; font-size: 0.8rem;">
                                                Cantidad en gramos (1 taza ‚âà 240g, 1 rebanada ‚âà 30g)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    
                    <div class="mt-3 mb-4 text-center">
                        <button type="button" class="btn btn-primary-custom" @onclick="AgregarAlimento">
                            <span style="font-size: 1.2rem; margin-right: 0.3rem;">‚ûï</span> Agregar otra comida
                        </button>
                        <p style="color: var(--color-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
                            Puedes agregar todas las comidas que hayas tenido hoy
                        </p>
                    </div>
                    
                    <div class="mt-4 d-flex gap-2">
                        <button type="submit" class="btn btn-warning-custom flex-grow-1" disabled="@isSubmitting">
                            @if (isSubmitting)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                <span style="font-size: 1.2rem; margin-right: 0.3rem;">üíæ</span>
                                <span>Guardar lo que com√≠</span>
                            }
                        </button>
                        
                        <button type="button" class="btn btn-secondary-custom" @onclick="LimpiarFormulario"
                                title="Limpiar todo el formulario">
                            <span style="font-size: 1.2rem; margin-right: 0.3rem;">üóëÔ∏è</span>
                            Limpiar
                        </button>
                    </div>
                </EditForm>
                
                @if (!string.IsNullOrEmpty(mensajeExito))
                {
                    <div class="alert alert-success mt-3">
                        <div class="d-flex align-items-center">
                            <span style="font-size: 1.5rem; margin-right: 0.5rem;">‚úÖ</span>
                            <div>@mensajeExito</div>
                        </div>
                    </div>
                }
                
                @if (!string.IsNullOrEmpty(mensajeError))
                {
                    <div class="alert alert-danger mt-3">
                        <div class="d-flex align-items-center">
                            <span style="font-size: 1.5rem; margin-right: 0.5rem;">‚ùå</span>
                            <div>@mensajeError</div>
                        </div>
                    </div>
                }
            }
        </div>
        
        <div class="card-footer">
            <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-custom" @onclick="IrAHistorialConsumos">
                    <span style="font-size: 1.2rem; margin-right: 0.3rem;">üìã</span>
                    Ver mi historial
                </button>
                <div style="color: var(--color-secondary); font-size: 0.9rem;">
                    Total de alimentos: @nuevoRegistro.AlimentosConsumidos.Count
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int estudianteId { get; set; }
    
    [SupplyParameterFromForm]
    private RegistroConsumoNuevoDTO nuevoRegistro { get; set; } = new();
    
    private List<AlimentosDTO> alimentos = new();
    private List<TipoComidaDTO> tiposComida = new();
    private bool isLoadingCatalogos = true;
    private bool isSubmitting = false;
    private string mensajeExito = string.Empty;
    private string mensajeError = string.Empty;
    private Dictionary<string, string> errors = new();
    
    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("üîç Inicializando componente de registro de alimentos...");
        await CargarCatalogos();
        
        if (nuevoRegistro.AlimentosConsumidos == null || !nuevoRegistro.AlimentosConsumidos.Any())
        {
            AgregarAlimento();
        }
    }
    
    protected override void OnParametersSet()
    {
        if (estudianteId > 0)
        {
            nuevoRegistro.EstudianteId = estudianteId;
            Console.WriteLine($"üë§ Estudiante ID establecido desde URL: {estudianteId}");
        }
    }
    
    private async Task CargarCatalogos()
    {
        try
        {
            Console.WriteLine("üì• Cargando opciones...");
            var alimentosTask = AlimentoService.ObtenerTodosAsync();
            var tiposComidaTask = TipoComidaService.ObtenerTodosAsync();
            
            await Task.WhenAll(alimentosTask, tiposComidaTask);
            
            alimentos = await alimentosTask ?? new List<AlimentosDTO>();
            tiposComida = await tiposComidaTask ?? new List<TipoComidaDTO>();
            
            Console.WriteLine($"‚úÖ Opciones cargadas: {alimentos.Count} alimentos, {tiposComida.Count} tipos de comida");
        }
        catch (Exception ex)
        {
            mensajeError = $"Error cargando opciones: {ex.Message}";
            Console.WriteLine($"‚ùå Error cargando opciones: {ex.Message}");
        }
        finally
        {
            isLoadingCatalogos = false;
        }
    }
    
    private string GetTipoComidaNombre(int tipoComidaId)
    {
        var tipo = tiposComida.FirstOrDefault(t => t.TipoComidaId == tipoComidaId);
        return tipo != null ? tipo.Nombre : "Sin seleccionar";
    }
    
    private bool ValidarFormulario()
    {
        errors.Clear();
        
        if (nuevoRegistro.EstudianteId <= 0)
        {
            errors["General"] = "No se ha especificado el estudiante";
            return false;
        }
        
        if (nuevoRegistro.AlimentosConsumidos == null || !nuevoRegistro.AlimentosConsumidos.Any())
        {
            errors["Alimentos"] = "Debe agregar al menos un alimento";
        }
        else
        {
            for (int i = 0; i < nuevoRegistro.AlimentosConsumidos.Count; i++)
            {
                var alimento = nuevoRegistro.AlimentosConsumidos[i];
                
                if (alimento.AlimentoId <= 0)
                    errors[$"Alimento_{i}"] = "Seleccione un alimento";
                
                if (alimento.TipoComidaId <= 0)
                    errors[$"TipoComida_{i}"] = "Seleccione un tipo de comida";
                
                if (alimento.Cantidad <= 0)
                    errors[$"Cantidad_{i}"] = "La cantidad debe ser mayor a 0";
            }
        }
        
        return errors.Count == 0;
    }
    
    private void AgregarAlimento()
    {
        nuevoRegistro.AlimentosConsumidos.Add(new RegistroAlimentoItemDTO());
    }
    
    private void EliminarAlimento(int index)
    {
        if (nuevoRegistro.AlimentosConsumidos.Count > 1)
        {
            nuevoRegistro.AlimentosConsumidos.RemoveAt(index);
        }
    }
    
    private async Task RegistrarConsumo()
    {
        Console.WriteLine("üîÑ Guardando lo que comiste...");
        
        if (!ValidarFormulario())
        {
            mensajeError = "Por favor, completa toda la informaci√≥n correctamente";
            mensajeExito = string.Empty;
            return;
        }
        
        isSubmitting = true;
        mensajeExito = string.Empty;
        mensajeError = string.Empty;
        
        try
        {
            Console.WriteLine("üì§ Estableciendo fecha y hora actual...");
            
            nuevoRegistro.Fecha = DateOnly.FromDateTime(DateTime.Now);
            nuevoRegistro.Hora = TimeOnly.FromDateTime(DateTime.Now);
            
            Console.WriteLine($"üìÖ Fecha: {nuevoRegistro.Fecha}");
            Console.WriteLine($"‚è∞ Hora: {nuevoRegistro.Hora}");
            Console.WriteLine($"üì¶ Datos a enviar: {JsonSerializer.Serialize(nuevoRegistro)}");
            
            var resultado = await RegistroAlimentoService.RegistrarConsumoAsync(nuevoRegistro);
            
            if (resultado)
            {
                mensajeExito = "¬°Listo! Registramos lo que comiste hoy";
                Console.WriteLine("‚úÖ Registro guardado exitosamente");
                
                await Task.Delay(1000);
                isSubmitting = false;
                
                if (nuevoRegistro.EstudianteId > 0)
                    Navigation.NavigateTo($"/alimentos/historial/{nuevoRegistro.EstudianteId}");
                else
                    LimpiarFormulario();
            }
            else
            {
                mensajeError = "Hubo un problema al guardar. Intenta de nuevo.";
                Console.WriteLine("‚ùå Error al guardar");
                isSubmitting = false;
            }
        }
        catch (Exception ex)
        {
            if (ex.GetType().Name != "NavigationException")
            {
                mensajeError = $"Error: {ex.Message}";
                Console.WriteLine($"‚ùå Excepci√≥n: {ex.Message}");
                Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            }
            isSubmitting = false;
        }
    }
    
    private void LimpiarFormulario()
    {
        var estudianteIdActual = nuevoRegistro.EstudianteId;
        nuevoRegistro = new RegistroConsumoNuevoDTO
        {
            EstudianteId = estudianteIdActual
        };
        AgregarAlimento();
        errors.Clear();
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
    }
    
    private void IrAHistorialConsumos()
    {
        Console.WriteLine("üîó Navegando al historial...");
        if (nuevoRegistro.EstudianteId > 0)
            Navigation.NavigateTo($"/alimentos/historial/{nuevoRegistro.EstudianteId}");
        else
            Navigation.NavigateTo("/alimentos/historial");
    }
}

<style>
    :root {
        --color-primary: #BCD09F;
        --color-secondary: #576E40;
        --color-dark: #221C04;
        --color-accent: #C2854C;
        --color-light: #F1EAC0;
    }
    
    .header-custom {
        background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
        color: white;
        border: none;
        padding: 1.5rem;
    }
    
    .btn-primary-custom {
        background-color: var(--color-primary);
        border-color: var(--color-primary);
        color: var(--color-dark);
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }
    
    .btn-primary-custom:hover {
        background-color: var(--color-secondary);
        border-color: var(--color-secondary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(87, 110, 64, 0.3);
    }
    
    .btn-warning-custom {
        background-color: var(--color-accent);
        border-color: var(--color-accent);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        font-size: 1.1rem;
    }
    
    .btn-warning-custom:hover {
        background-color: #a66f3d;
        border-color: #a66f3d;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(194, 133, 76, 0.4);
    }
    
    .btn-danger-custom {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .btn-danger-custom:hover {
        background-color: #c82333;
        border-color: #c82333;
        transform: scale(1.1);
    }
    
    .btn-secondary-custom {
        background-color: var(--color-light);
        border-color: var(--color-light);
        color: var(--color-dark);
        font-weight: 600;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }
    
    .btn-secondary-custom:hover {
        background-color: #e4ddb0;
        border-color: #e4ddb0;
        color: var(--color-dark);
    }
    
    .btn-outline-custom {
        background-color: transparent;
        border-color: var(--color-secondary);
        color: var(--color-secondary);
        font-weight: 600;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }
    
    .btn-outline-custom:hover {
        background-color: var(--color-secondary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(87, 110, 64, 0.3);
    }
    
    .alert-info-custom {
        background-color: var(--color-light);
        border-color: var(--color-primary);
        color: var(--color-dark);
        border-left: 4px solid var(--color-primary);
        border-radius: 8px;
    }
    
    .alert-empty {
        background-color: rgba(188, 208, 159, 0.1);
        border: 2px dashed var(--color-primary);
        border-radius: 12px;
        padding: 2rem;
    }
    
    .card-alimento {
        border: 2px solid var(--color-light);
        border-radius: 10px;
        transition: all 0.3s ease;
    }
    
    .card-alimento:hover {
        border-color: var(--color-primary);
        box-shadow: 0 4px 12px rgba(188, 208, 159, 0.3);
    }
    
    .card-header-alimento {
        background-color: var(--color-light);
        border-bottom: 2px solid var(--color-primary);
        font-weight: 600;
        color: var(--color-dark);
    }
    
    .form-label-custom {
        color: var(--color-secondary);
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .form-select-custom, .form-control-custom {
        border: 2px solid var(--color-light);
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 0.6rem;
    }
    
    .form-select-custom:focus, .form-control-custom:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.3rem rgba(188, 208, 159, 0.25);
    }
    
    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
        border-left: 4px solid #28a745;
        border-radius: 8px;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
        border-left: 4px solid #dc3545;
        border-radius: 8px;
    }
</style>