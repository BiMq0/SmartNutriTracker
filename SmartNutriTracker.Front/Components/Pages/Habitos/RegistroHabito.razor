@page "/habitos/registrar/{estudianteId:int}"
@page "/habitos/registrar"
@rendermode InteractiveServer
@using SmartNutriTracker.Shared.DTOs.Habitos
@using SmartNutriTracker.Front.Services 
@using System.Text.Json
@inject RegistroHabitoService RegistroHabitoService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header header-custom">
            <h3 class="mb-0">üò¥ Registrar mi d√≠a</h3>
            <p class="mb-0" style="opacity: 0.9; font-size: 0.9rem;">Cu√©ntanos c√≥mo estuvo tu d√≠a de descanso y actividad</p>
        </div>
        
        <div class="card-body">
            <EditForm Model="@nuevoRegistro" OnValidSubmit="@RegistrarHabito" FormName="RegistroHabitoForm">
                <div class="mb-4">
                    <div class="alert alert-info-custom">
                        <div class="d-flex align-items-center">
                            <div style="font-size: 1.5rem; margin-right: 0.5rem;">üìÖ</div>
                            <div>
                                <strong>Registro del d√≠a @DateTime.Now.ToString("dd/MM/yyyy")</strong><br/>
                                <small>Hora actual: @DateTime.Now.ToString("HH:mm")</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="habito-card sueno">
                            <div class="habito-icon">
                                <span style="font-size: 2rem;">üò¥</span>
                            </div>
                            <div class="habito-content">
                                <label class="form-label form-label-custom">¬øCu√°ntas horas dormiste hoy? *</label>
                                <div class="input-group">
                                    <InputNumber step="0.5" class="form-control form-control-custom habito-input" 
                                               @bind-Value="nuevoRegistro.HorasSueno" />
                                    <span class="input-group-text" style="background-color: var(--color-light); border-color: var(--color-light); color: var(--color-dark);">horas</span>
                                </div>
                                <div class="habito-info mt-2">
                                    <small style="color: var(--color-secondary); opacity: 0.8;">
                                        <span style="font-weight: 600;">Recomendado:</span> 7-9 horas para adultos
                                    </small>
                                    <div class="mt-1">
                                        <small style="color: var(--color-secondary); opacity: 0.8; font-size: 0.85rem;">
                                            <span style="font-weight: 600;">Tip:</span> Incluye siesta y horas nocturnas
                                        </small>
                                    </div>
                                </div>
                                @if (errors.ContainsKey("HorasSueno"))
                                {
                                    <small class="text-danger d-block mt-2">@errors["HorasSueno"]</small>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-4">
                        <div class="habito-card ejercicio">
                            <div class="habito-icon">
                                <span style="font-size: 2rem;">üèÉ</span>
                            </div>
                            <div class="habito-content">
                                <label class="form-label form-label-custom">¬øCu√°nto tiempo hiciste ejercicio? *</label>
                                <div class="input-group">
                                    <InputNumber step="0.5" class="form-control form-control-custom habito-input" 
                                               @bind-Value="nuevoRegistro.HorasActividadFisica" />
                                    <span class="input-group-text" style="background-color: var(--color-light); border-color: var(--color-light); color: var(--color-dark);">horas</span>
                                </div>
                                <div class="habito-info mt-2">
                                    <small style="color: var(--color-secondary); opacity: 0.8;">
                                        <span style="font-weight: 600;">Recomendado:</span> M√≠nimo 30 minutos diarios
                                    </small>
                                    <div class="mt-1">
                                        <small style="color: var(--color-secondary); opacity: 0.8; font-size: 0.85rem;">
                                            <span style="font-weight: 600;">Tip:</span> Incluye caminata, deportes, gimnasio, etc.
                                        </small>
                                    </div>
                                </div>
                                @if (errors.ContainsKey("HorasActividadFisica"))
                                {
                                    <small class="text-danger d-block mt-2">@errors["HorasActividadFisica"]</small>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="resumen-habitos mt-4 mb-4">
                    <h5 style="color: var(--color-secondary); margin-bottom: 1rem;">
                        <span style="font-size: 1.5rem;">üìä</span> Resumen de tu d√≠a
                    </h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="resumen-item sueno-resumen">
                                <div class="resumen-label">Horas de sue√±o</div>
                                <div class="resumen-valor">@nuevoRegistro.HorasSueno.ToString("0.0") h</div>
                                <div class="resumen-evaluacion">@EvaluarSueno((decimal)nuevoRegistro.HorasSueno)</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="resumen-item ejercicio-resumen">
                                <div class="resumen-label">Actividad f√≠sica</div>
                                <div class="resumen-valor">@nuevoRegistro.HorasActividadFisica.ToString("0.0") h</div>
                                <div class="resumen-evaluacion">@EvaluarEjercicio((decimal)nuevoRegistro.HorasActividadFisica)</div>
                            </div>
                        </div>
                    </div>
                    <div class="total-dia mt-3">
                        <div class="total-label">Total activo del d√≠a</div>
                        <div class="total-valor">@((nuevoRegistro.HorasSueno + nuevoRegistro.HorasActividadFisica).ToString("0.0")) horas</div>
                    </div>
                </div>
                
                <div class="mt-4 d-flex gap-2">
                    <button type="submit" class="btn btn-warning-custom flex-grow-1" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                            <span>Guardando...</span>
                        }
                        else
                        {
                            <span style="font-size: 1.2rem; margin-right: 0.3rem;">üíæ</span>
                            <span>Guardar mi d√≠a</span>
                        }
                    </button>
                    
                    <button type="button" class="btn btn-secondary-custom" @onclick="LimpiarFormulario"
                            title="Restablecer valores">
                        <span style="font-size: 1.2rem; margin-right: 0.3rem;">üóëÔ∏è</span>
                        Limpiar
                    </button>
                </div>
            </EditForm>
            
            @if (!string.IsNullOrEmpty(mensajeExito))
            {
                <div class="alert alert-success mt-3">
                    <div class="d-flex align-items-center">
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">‚úÖ</span>
                        <div>@mensajeExito</div>
                    </div>
                </div>
            }
            
            @if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger mt-3">
                    <div class="d-flex align-items-center">
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">‚ùå</span>
                        <div>@mensajeError</div>
                    </div>
                </div>
            }
        </div>
        
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <button class="btn btn-outline-custom" @onclick="IrAHistorialHabitos">
                    <span style="font-size: 1.2rem; margin-right: 0.3rem;">üìã</span>
                    Ver mi progreso
                </button>
                <small style="color: var(--color-secondary);">
                    <span style="font-weight: 600;">Consejo:</span> Registra diariamente para mejores resultados
                </small>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int estudianteId { get; set; }
    
    [SupplyParameterFromForm]
    private RegistroHabitoNuevoDTO nuevoRegistro { get; set; } = new();
    
    private bool isSubmitting = false;
    private string mensajeExito = string.Empty;
    private string mensajeError = string.Empty;
    private Dictionary<string, string> errors = new();
    
    protected override void OnInitialized()
    {
        if (nuevoRegistro.HorasSueno == 0)
        {
            nuevoRegistro.HorasSueno = 8;
        }
        if (nuevoRegistro.HorasActividadFisica == 0)
        {
            nuevoRegistro.HorasActividadFisica = 1;
        }
    }
    
    protected override void OnParametersSet()
    {
        if (estudianteId > 0)
        {
            nuevoRegistro.EstudianteId = estudianteId;
            Console.WriteLine($"üë§ Estudiante ID establecido desde URL: {estudianteId}");
        }
    }
    
    private bool ValidarFormulario()
    {
        errors.Clear();
        
        if (nuevoRegistro.EstudianteId <= 0)
        {
            errors["General"] = "No se ha especificado el estudiante";
            return false;
        }
        
        if (nuevoRegistro.HorasSueno < 0 || nuevoRegistro.HorasSueno > 24)
            errors["HorasSueno"] = "Las horas de sue√±o deben estar entre 0 y 24 horas";
        
        if (nuevoRegistro.HorasActividadFisica < 0 || nuevoRegistro.HorasActividadFisica > 24)
            errors["HorasActividadFisica"] = "Las horas de actividad deben estar entre 0 y 24 horas";
        
        return errors.Count == 0;
    }
    
    private async Task RegistrarHabito()
    {
        Console.WriteLine("üîÑ Guardando mi d√≠a...");
        
        if (!ValidarFormulario())
        {
            mensajeError = "Por favor, completa toda la informaci√≥n correctamente";
            mensajeExito = string.Empty;
            return;
        }
        
        isSubmitting = true;
        mensajeExito = string.Empty;
        mensajeError = string.Empty;
        
        try
        {
            Console.WriteLine("üì§ Estableciendo fecha y hora actual...");
            
            nuevoRegistro.Fecha = DateOnly.FromDateTime(DateTime.Now);
            nuevoRegistro.Hora = TimeOnly.FromDateTime(DateTime.Now);
            
            Console.WriteLine($"üìÖ Fecha: {nuevoRegistro.Fecha}");
            Console.WriteLine($"‚è∞ Hora: {nuevoRegistro.Hora}");
            Console.WriteLine($"üì¶ Datos a enviar: {JsonSerializer.Serialize(nuevoRegistro)}");
            
            var resultado = await RegistroHabitoService.RegistrarHabitosAsync(nuevoRegistro);
            
            if (resultado)
            {
                mensajeExito = "¬°Perfecto! Registramos c√≥mo estuvo tu d√≠a";
                Console.WriteLine("‚úÖ D√≠a registrado exitosamente");
                
                // Navegar despu√©s de un breve delay
                await Task.Delay(1000);
                isSubmitting = false;
                
                if (nuevoRegistro.EstudianteId > 0)
                    Navigation.NavigateTo($"/habitos/historial/{nuevoRegistro.EstudianteId}");
                else
                    LimpiarFormulario();
            }
            else
            {
                mensajeError = "Hubo un problema al guardar. Intenta de nuevo.";
                Console.WriteLine("‚ùå Error al registrar el d√≠a");
                isSubmitting = false;
            }
        }
        catch (Exception ex)
        {
            // Ignorar NavigationException ya que es el comportamiento normal de Blazor
            if (ex.GetType().Name != "NavigationException")
            {
                mensajeError = $"Error: {ex.Message}";
                Console.WriteLine($"‚ùå Excepci√≥n: {ex.Message}");
                Console.WriteLine($"Stack Trace: {ex.StackTrace}");
            }
            isSubmitting = false;
        }
    }
    
    private void LimpiarFormulario()
    {
        var estudianteIdActual = nuevoRegistro.EstudianteId;
        nuevoRegistro = new RegistroHabitoNuevoDTO
        {
            EstudianteId = estudianteIdActual,
            HorasSueno = 8,
            HorasActividadFisica = 1
        };
        errors.Clear();
        mensajeError = string.Empty;
        mensajeExito = string.Empty;
    }
    
    private void IrAHistorialHabitos()
    {
        Console.WriteLine("üîó Navegando al historial de h√°bitos...");
        if (nuevoRegistro.EstudianteId > 0)
            Navigation.NavigateTo($"/habitos/historial/{nuevoRegistro.EstudianteId}");
        else
            Navigation.NavigateTo("/habitos/historial");
    }
    
    private string EvaluarSueno(decimal horas)
    {
        if (horas >= 7 && horas <= 9) return "üòä Excelente";
        if (horas >= 6 && horas < 7) return "üòê Puedes mejorar";
        if (horas > 9) return "üò¥ Demasiado";
        return "üòü Muy poco";
    }
    
    private string EvaluarEjercicio(decimal horas)
    {
        if (horas >= 1) return "üí™ ¬°Muy bien!";
        if (horas >= 0.5m) return "üëç Buena rutina";
        if (horas > 0) return "üòä Bien por empezar";
        return "üòï Sin actividad";
    }
}

<style>
    :root {
        --color-primary: #BCD09F;
        --color-secondary: #576E40;
        --color-dark: #221C04;
        --color-accent: #C2854C;
        --color-light: #F1EAC0;
    }
    
    .header-custom {
        background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
        color: white;
        border: none;
        padding: 1.5rem;
    }
    
    .habito-card {
        background-color: var(--color-light);
        border-radius: 12px;
        padding: 1.5rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        height: 100%;
    }
    
    .habito-card.sueno {
        border-color: #4A90E2;
    }
    
    .habito-card.ejercicio {
        border-color: #7ED321;
    }
    
    .habito-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }
    
    .habito-card.sueno:hover {
        box-shadow: 0 6px 16px rgba(74, 144, 226, 0.2);
    }
    
    .habito-card.ejercicio:hover {
        box-shadow: 0 6px 16px rgba(126, 211, 33, 0.2);
    }
    
    .habito-icon {
        text-align: center;
        margin-bottom: 1rem;
    }
    
    .habito-input {
        border: 2px solid var(--color-light);
        border-radius: 8px;
        padding: 0.6rem;
        font-size: 1.1rem;
        text-align: center;
        font-weight: 600;
    }
    
    .habito-input:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.3rem rgba(188, 208, 159, 0.25);
    }
    
    .input-group-text {
        border-radius: 0 8px 8px 0 !important;
        font-weight: 600;
    }
    
    .btn-warning-custom {
        background-color: var(--color-accent);
        border-color: var(--color-accent);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
        font-size: 1.1rem;
    }
    
    .btn-warning-custom:hover {
        background-color: #a66f3d;
        border-color: #a66f3d;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(194, 133, 76, 0.4);
    }
    
    .btn-secondary-custom {
        background-color: var(--color-light);
        border-color: var(--color-light);
        color: var(--color-dark);
        font-weight: 600;
        padding: 0.8rem 1.5rem;
        border-radius: 8px;
    }
    
    .btn-secondary-custom:hover {
        background-color: #e4ddb0;
        border-color: #e4ddb0;
        color: var(--color-dark);
    }
    
    .btn-outline-custom {
        background-color: transparent;
        border-color: var(--color-secondary);
        color: var(--color-secondary);
        font-weight: 600;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }
    
    .btn-outline-custom:hover {
        background-color: var(--color-secondary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(87, 110, 64, 0.3);
    }
    
    .alert-info-custom {
        background-color: var(--color-light);
        border-color: var(--color-primary);
        color: var(--color-dark);
        border-left: 4px solid var(--color-primary);
        border-radius: 8px;
    }
    
    .form-label-custom {
        color: var(--color-secondary);
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 1rem;
    }
    
    .form-control-custom {
        border: 2px solid var(--color-light);
        transition: border-color 0.3s ease;
        border-radius: 6px;
        padding: 0.5rem;
    }
    
    .form-control-custom:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.2rem rgba(188, 208, 159, 0.25);
    }
    
    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
        border-left: 4px solid #28a745;
        border-radius: 8px;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
        border-left: 4px solid #dc3545;
        border-radius: 8px;
    }
    
    .resumen-habitos {
        background-color: rgba(188, 208, 159, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        border: 2px solid var(--color-light);
    }
    
    .resumen-item {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
    
    .resumen-item.sueno-resumen {
        background-color: rgba(74, 144, 226, 0.1);
        border-left: 4px solid #4A90E2;
    }
    
    .resumen-item.ejercicio-resumen {
        background-color: rgba(126, 211, 33, 0.1);
        border-left: 4px solid #7ED321;
    }
    
    .resumen-label {
        font-size: 0.9rem;
        color: var(--color-secondary);
        margin-bottom: 0.3rem;
    }
    
    .resumen-valor {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--color-dark);
        margin-bottom: 0.3rem;
    }
    
    .resumen-evaluacion {
        font-size: 0.85rem;
        color: var(--color-secondary);
    }
    
    .total-dia {
        text-align: center;
        padding: 1rem;
        background-color: var(--color-accent);
        color: white;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .total-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .total-valor {
        font-size: 2rem;
        font-weight: 700;
    }
</style>