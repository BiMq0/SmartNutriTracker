@page "/habitos/historial/{estudianteId:int}"
@page "/habitos/historial"
@rendermode InteractiveServer
@using SmartNutriTracker.Shared.DTOs.Habitos
@using SmartNutriTracker.Front.Services 
@inject HabitoService HabitoService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h3 class="mb-0">ğŸ“Š Historial de HÃ¡bitos</h3>
        </div>
        
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">ğŸ‘¤ ID Estudiante</span>
                        <input type="number" class="form-control" 
                               value="@estudianteId"
                               @oninput="@(e => estudianteId = int.TryParse(e.Value?.ToString(), out var val) ? val : 0)"
                               @onkeypress="@(async (e) => { if (e.Key == "Enter") await CargarHabitos(); })" />
                        <button type="button" class="btn btn-outline-success" @onclick="async () => await CargarHabitos()">
                            ğŸ” Buscar
                        </button>
                    </div>
                </div>
                
                <div class="col-md-6 text-end">
                    <button type="button" class="btn btn-success" @onclick="IrARegistrarHabito">
                        â• Nuevo Registro
                    </button>
                </div>
            </div>
            
            @if (isLoading)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando historial...</p>
                </div>
            }
            else if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger">
                    âŒ @mensajeError
                </div>
            }
            else if (habitos == null || !habitos.Any())
            {
                <div class="alert alert-info">
                    â„¹ï¸ No se encontraron registros de hÃ¡bitos para el estudiante @estudianteId
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>ğŸ“… Fecha</th>
                                <th>ğŸ˜´ Horas SueÃ±o</th>
                                <th>ğŸ’ª Horas Actividad</th>
                                <th>âš¡ Total Horas</th>
                                <th>ğŸ”§ Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var habito in habitos)
                            {
                                <tr>
                                    <td>@habito.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <span class="badge bg-info">@habito.HorasSueno horas</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">@habito.HorasActividadFisica horas</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@(habito.HorasSueno + habito.HorasActividadFisica) horas</span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-warning" 
                                                @onclick="@(() => EditarHabito(habito.RegistroHabitoId))">
                                            âœï¸ Editar
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int estudianteId { get; set; }
    
    private List<HabitoRegistroDTO> habitos = new();
    private bool isLoading = false;
    private string mensajeError = string.Empty;
    
    protected override async Task OnParametersSetAsync()
    {
        if (estudianteId > 0)
        {
            await CargarHabitos();
        }
    }
    
    private async Task CargarHabitos()
    {
        if (estudianteId <= 0)
        {
            mensajeError = "Ingrese un ID de estudiante vÃ¡lido";
            return;
        }
        
        isLoading = true;
        mensajeError = string.Empty;
        
        try
        {
            habitos = await HabitoService.ObtenerHabitosPorEstudianteAsync(estudianteId) 
                     ?? new List<HabitoRegistroDTO>();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error cargando hÃ¡bitos: {ex.Message}";
            habitos = new List<HabitoRegistroDTO>();
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private void EditarHabito(int registroHabitoId)
    {
        Console.WriteLine($"ğŸ”— Navegando a editar hÃ¡bito {registroHabitoId}");
        Navigation.NavigateTo($"/habitos/editar/{registroHabitoId}");
    }
    
    private void IrARegistrarHabito()
    {
        Navigation.NavigateTo("/habitos/registrar");
    }
}