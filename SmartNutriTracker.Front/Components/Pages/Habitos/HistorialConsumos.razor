@page "/alimentos/historial/{estudianteId:int}"
@page "/alimentos/historial"
@rendermode InteractiveServer
@using SmartNutriTracker.Shared.DTOs.Alimentos
@using SmartNutriTracker.Front.Services 
@inject RegistroAlimentoService RegistroAlimentoService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-success text-white">
            <h3 class="mb-0">üçé Historial de Consumo de Alimentos</h3>
        </div>
        
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">üë§ ID Estudiante</span>
                        <input type="number" class="form-control" 
                               value="@estudianteId"
                               @oninput="@(e => estudianteId = int.TryParse(e.Value?.ToString(), out var val) ? val : 0)"
                               @onkeypress="@(async (e) => { if (e.Key == "Enter") await CargarConsumos(); })" />
                        <button class="btn btn-outline-success" @onclick="async () => await CargarConsumos()">
                            üîç Buscar
                        </button>
                    </div>
                </div>
                
                <div class="col-md-6 text-end">
                    <button class="btn btn-primary" @onclick="IrARegistrarConsumo">
                        ‚ûï Nuevo Registro
                    </button>
                </div>
            </div>
            
            @if (isLoading)
            {
                <div class="text-center py-4">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando historial...</p>
                </div>
            }
            else if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger">
                    ‚ùå @mensajeError
                </div>
            }
            else if (consumos == null || !consumos.Any())
            {
                <div class="alert alert-info">
                    ‚ÑπÔ∏è No se encontraron registros de consumo para el estudiante @estudianteId
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>üìÖ Fecha y Hora</th>
                                <th>üçé Alimentos</th>
                                <th>‚ö° Calor√≠as Totales</th>
                                <th>üîß Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var consumo in consumos)
                            {
                                var totalCalorias = consumo.AlimentosConsumidos.Sum(a => a.Calorias * a.Cantidad / 100);
                                
                                <tr>
                                    <td>@consumo.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td>
                                        <div class="d-grid gap-1">
                                            @foreach (var alimento in consumo.AlimentosConsumidos)
                                            {
                                                <div class="bg-light p-2 rounded">
                                                    <small>
                                                        <strong>@alimento.AlimentoNombre</strong> 
                                                        (@alimento.Cantidad g) - 
                                                        @alimento.Calorias kcal/100g
                                                    </small>
                                                </div>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning text-dark fs-6">
                                            @totalCalorias.ToString("0.0") kcal
                                        </span>
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-warning" 
                                                @onclick="@(() => EditarConsumo(consumo.RegistroHabitoId))">
                                            ‚úèÔ∏è Editar
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int estudianteId { get; set; }
    
    private List<RegistroConsumoDTO> consumos = new();
    private bool isLoading = false;
    private string mensajeError = string.Empty;
    
    protected override async Task OnParametersSetAsync()
    {
        if (estudianteId > 0)
        {
            await CargarConsumos();
        }
    }
    
    private async Task CargarConsumos()
    {
        if (estudianteId <= 0)
        {
            mensajeError = "Ingrese un ID de estudiante v√°lido";
            return;
        }
        
        isLoading = true;
        mensajeError = string.Empty;
        
        try
        {
            consumos = await RegistroAlimentoService.ObtenerPorEstudianteAsync(estudianteId) 
                      ?? new List<RegistroConsumoDTO>();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error cargando consumos: {ex.Message}";
            consumos = new List<RegistroConsumoDTO>();
        }
        finally
        {
            isLoading = false;
        }
    }
    
    // ‚úÖ CORRECCI√ìN: Usar par√°metro de ruta en lugar de query string
    private void EditarConsumo(int registroHabitoId)
    {
        Console.WriteLine($"üîó Navegando a editar consumo {registroHabitoId}");
        Navigation.NavigateTo($"/alimentos/editar/{registroHabitoId}");
    }
    
    private void IrARegistrarConsumo()
    {
        Navigation.NavigateTo("/alimentos/registrar");
    }
}