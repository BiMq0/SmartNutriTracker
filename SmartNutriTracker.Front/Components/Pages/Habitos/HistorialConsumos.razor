@page "/alimentos/historial/{estudianteId:int}"
@page "/alimentos/historial"
@rendermode InteractiveServer
@using SmartNutriTracker.Shared.DTOs.Alimentos
@using SmartNutriTracker.Front.Services 
@inject RegistroAlimentoService RegistroAlimentoService
@inject AlimentosService AlimentoService
@inject NavigationManager Navigation

<div class="container mt-4">
    <div class="card shadow-lg">
        <div class="card-header header-custom">
            <h3 class="mb-0">üìñ Tu historia alimenticia</h3>
        </div>
        
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-12 text-end">
                    <button class="btn btn-primary-custom" @onclick="IrARegistrarConsumo">
                        ‚ûï Registrar nueva comida
                    </button>
                </div>
            </div>

            <div class="card filter-card mb-4">
                <div class="card-header filter-header">
                    <h5 class="mb-0">üîç Filtros de b√∫squeda</h5>
                    <small>Usa los filtros para encontrar registros espec√≠ficos</small>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label form-label-custom">üìÖ Filtrar por fecha</label>
                                <input type="date" class="form-control form-control-custom" 
                                       value="@filtroFechaString"
                                       @onchange="@((e) => filtroFechaString = e.Value?.ToString())" />
                                <small style="color: var(--color-secondary); opacity: 0.8; font-size: 0.8rem;">
                                    Deja vac√≠o para ver todos los registros
                                </small>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label form-label-custom">üçé Filtrar por alimento</label>
                                <select class="form-select form-select-custom" 
                                        @onchange="@(e => { if (int.TryParse(e.Value?.ToString(), out var val)) filtroAlimentoId = val; })">
                                    <option value="0">-- Todos los alimentos --</option>
                                    @if (alimentosFiltro != null && alimentosFiltro.Any())
                                    {
                                        @foreach (var alimento in alimentosFiltro)
                                        {
                                            <option value="@alimento.AlimentoId" selected="@(filtroAlimentoId == alimento.AlimentoId)">
                                                @alimento.Nombre
                                            </option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label form-label-custom">‚ö° Filtrar por calor√≠as</label>
                                <select class="form-select form-select-custom" 
                                        @onchange="@(e => { if (int.TryParse(e.Value?.ToString(), out var val)) filtroCalorias = val; })">
                                    <option value="0">-- Todas las calor√≠as --</option>
                                    <option value="100" selected="@(filtroCalorias == 100)">Menos de 100 kcal</option>
                                    <option value="250" selected="@(filtroCalorias == 250)">Menos de 250 kcal</option>
                                    <option value="500" selected="@(filtroCalorias == 500)">Menos de 500 kcal</option>
                                    <option value="750" selected="@(filtroCalorias == 750)">Menos de 750 kcal</option>
                                    <option value="1000" selected="@(filtroCalorias == 1000)">Menos de 1000 kcal</option>
                                    <option value="2000" selected="@(filtroCalorias == 2000)">M√°s de 1000 kcal</option>
                                </select>
                                <small style="color: var(--color-secondary); opacity: 0.8; font-size: 0.8rem;">
                                    Filtra por rango de calor√≠as totales
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-12 d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary-custom" @onclick="AplicarFiltros">
                                <span style="margin-right: 0.5rem;">üîç</span>
                                Aplicar filtros
                            </button>
                            
                            <button type="button" class="btn btn-outline-custom" @onclick="LimpiarFiltros">
                                <span style="margin-right: 0.5rem;">üóëÔ∏è</span>
                                Limpiar filtros
                            </button>
                        </div>
                    </div>
                    
                    @if (FiltrosActivos)
                    {
                        <div class="mt-3">
                            <div class="alert alert-info-custom py-2">
                                <div class="d-flex align-items-center">
                                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">üìä</span>
                                    <div>
                                        <strong>Filtros activos:</strong>
                                        @if (!string.IsNullOrEmpty(filtroFechaString))
                                        {
                                            <span class="badge-filter">Fecha: @filtroFechaString</span>
                                        }
                                        @if (filtroAlimentoId > 0 && alimentoSeleccionado != null)
                                        {
                                            <span class="badge-filter">Alimento: @alimentoSeleccionado.Nombre</span>
                                        }
                                        @if (filtroCalorias > 0)
                                        {
                                            <span class="badge-filter">Calor√≠as: @ObtenerTextoFiltroCalorias()</span>
                                        }
                                        <span class="badge-filter">Resultados: @consumosFiltrados.Count</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border" style="color: var(--color-accent); width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3" style="color: var(--color-secondary); font-size: 1.1rem;">Cargando tu historial...</p>
                </div>
            }
            else if (!string.IsNullOrEmpty(mensajeError))
            {
                <div class="alert alert-danger">
                    <div class="d-flex align-items-center">
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">‚ùå</span>
                        <div>@mensajeError</div>
                    </div>
                </div>
            }
            else if (consumos == null || !consumos.Any())
            {
                <div class="alert-empty">
                    <div class="text-center py-5">
                        <div style="font-size: 4rem; opacity: 0.3;">üçΩÔ∏è</div>
                        <h4 style="color: var(--color-secondary); margin-top: 1rem;">A√∫n no hay registros</h4>
                        <p style="color: var(--color-secondary); opacity: 0.8;">Comienza a registrar lo que comes para llevar un mejor control</p>
                        <button class="btn btn-primary-custom mt-3" @onclick="IrARegistrarConsumo">
                            ‚ûï Hacer mi primer registro
                        </button>
                    </div>
                </div>
            }
            else
            {
                @if (consumosFiltrados.Count == 0 && FiltrosActivos)
                {
                    <div class="alert alert-warning-custom">
                        <div class="d-flex align-items-center">
                            <span style="font-size: 1.5rem; margin-right: 0.5rem;">üîç</span>
                            <div>
                                <strong>No se encontraron registros con los filtros aplicados</strong>
                                <p class="mb-0">Intenta con otros criterios de b√∫squeda</p>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead class="table-header-custom">
                                <tr>
                                    <th>üìÖ Fecha</th>
                                    <th>üçé ¬øQu√© comiste?</th>
                                    <th>‚ö° Calor√≠as</th>
                                    <th>üîß Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var consumo in consumosFiltrados)
                                {
                                    var totalCalorias = consumo.AlimentosConsumidos.Sum(a => 
                                        Convert.ToDouble(a.Calorias) * Convert.ToDouble(a.Cantidad) / 100.0);
                                    
                                    <tr class="table-row-custom">
                                        <td class="fecha-cell">
                                            <strong>@consumo.Fecha.ToString("dd/MM/yyyy")</strong>
                                        </td>
                                        <td>
                                            <div class="d-grid gap-2">
                                                @foreach (var alimento in consumo.AlimentosConsumidos)
                                                {
                                                    <div class="alimento-item">
                                                        <div class="alimento-nombre">@alimento.AlimentoNombre</div>
                                                        <div class="alimento-detalle">
                                                            @alimento.Cantidad g ‚Ä¢ @alimento.Calorias kcal/100g
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge-calorias">
                                                @totalCalorias.ToString("0") kcal
                                            </span>
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-sm btn-warning-custom" 
                                                    @onclick="@(() => EditarConsumo(consumo.RegistroHabitoId))">
                                                ‚úèÔ∏è Editar
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <div>
                            <p style="color: var(--color-secondary); margin-bottom: 0;">
                                Mostrando <strong>@consumosFiltrados.Count</strong> de <strong>@consumos.Count</strong> registros
                            </p>
                        </div>
                        <div>
                            @if (consumosFiltrados.Count < consumos.Count)
                            {
                                <button type="button" class="btn btn-outline-custom btn-sm" @onclick="LimpiarFiltros">
                                    Ver todos los registros
                                </button>
                            }
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public int estudianteId { get; set; }
    
    private List<RegistroConsumoDTO> consumos = new();
    private List<RegistroConsumoDTO> consumosFiltrados = new();
    private List<AlimentosDTO> alimentosFiltro = new();
    private bool isLoading = false;
    private string mensajeError = string.Empty;
    
    // Variables para filtros
    private string filtroFechaString = string.Empty;
    private int filtroAlimentoId = 0;
    private int filtroCalorias = 0;
    private AlimentosDTO alimentoSeleccionado = null;
    
    private bool FiltrosActivos => !string.IsNullOrEmpty(filtroFechaString) || filtroAlimentoId > 0 || filtroCalorias > 0;
    
    protected override async Task OnParametersSetAsync()
    {
        if (estudianteId > 0)
        {
            await CargarDatosIniciales();
        }
    }
    
    private async Task CargarDatosIniciales()
    {
        isLoading = true;
        
        try
        {
            // Cargar consumos
            await CargarConsumos();
            
            // Cargar alimentos para el filtro
            await CargarAlimentosFiltro();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error cargando datos: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    
    private async Task CargarConsumos()
    {
        if (estudianteId <= 0)
        {
            mensajeError = "Ingrese un ID de estudiante v√°lido";
            return;
        }
        
        try
        {
            consumos = await RegistroAlimentoService.ObtenerPorEstudianteAsync(estudianteId) 
                      ?? new List<RegistroConsumoDTO>();
            
            // Inicializar la lista filtrada con todos los consumos
            consumosFiltrados = new List<RegistroConsumoDTO>(consumos);
        }
        catch (Exception ex)
        {
            mensajeError = $"Error cargando consumos: {ex.Message}";
            consumos = new List<RegistroConsumoDTO>();
            consumosFiltrados = new List<RegistroConsumoDTO>();
        }
    }
    
    private async Task CargarAlimentosFiltro()
    {
        try
        {
            alimentosFiltro = await AlimentoService.ObtenerTodosAsync() 
                             ?? new List<AlimentosDTO>();
            
            // Ordenar alfab√©ticamente
            alimentosFiltro = alimentosFiltro.OrderBy(a => a.Nombre).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando alimentos para filtro: {ex.Message}");
            alimentosFiltro = new List<AlimentosDTO>();
        }
    }
    
    private void AplicarFiltros()
    {
        try
        {
            // Obtener alimento seleccionado si aplica
            if (filtroAlimentoId > 0)
            {
                alimentoSeleccionado = alimentosFiltro.FirstOrDefault(a => a.AlimentoId == filtroAlimentoId);
            }
            else
            {
                alimentoSeleccionado = null;
            }
            
            // Aplicar filtros en cascada
            var resultado = consumos.AsEnumerable();
            
            // Filtro por fecha (usando string en formato yyyy-MM-dd)
            if (!string.IsNullOrEmpty(filtroFechaString))
            {
                if (DateTime.TryParse(filtroFechaString, out DateTime fechaFiltro))
                {
                    resultado = resultado.Where(c => 
                        c.Fecha.Year == fechaFiltro.Year && 
                        c.Fecha.Month == fechaFiltro.Month && 
                        c.Fecha.Day == fechaFiltro.Day);
                }
            }
            
            // Filtro por alimento
            if (filtroAlimentoId > 0 && alimentoSeleccionado != null)
            {
                resultado = resultado.Where(c => 
                    c.AlimentosConsumidos.Any(a => a.AlimentoId == filtroAlimentoId));
            }
            
            // Filtro por calor√≠as
            if (filtroCalorias > 0)
            {
                resultado = resultado.Where(c => 
                {
                    var totalCalorias = c.AlimentosConsumidos.Sum(a => 
                        Convert.ToDouble(a.Calorias) * Convert.ToDouble(a.Cantidad) / 100.0);
                    return AplicarFiltroCalorias(totalCalorias);
                });
            }
            
            consumosFiltrados = resultado.ToList();
            
            // Forzar actualizaci√≥n de la UI
            StateHasChanged();
        }
        catch (Exception ex)
        {
            mensajeError = $"Error aplicando filtros: {ex.Message}";
            Console.WriteLine($"Error en AplicarFiltros: {ex.Message}");
        }
    }
    
    private bool AplicarFiltroCalorias(double totalCalorias)
    {
        switch (filtroCalorias)
        {
            case 100: return totalCalorias < 100;
            case 250: return totalCalorias < 250;
            case 500: return totalCalorias < 500;
            case 750: return totalCalorias < 750;
            case 1000: return totalCalorias < 1000;
            case 2000: return totalCalorias > 1000;
            default: return true;
        }
    }
    
    private string ObtenerTextoFiltroCalorias()
    {
        switch (filtroCalorias)
        {
            case 100: return "< 100 kcal";
            case 250: return "< 250 kcal";
            case 500: return "< 500 kcal";
            case 750: return "< 750 kcal";
            case 1000: return "< 1000 kcal";
            case 2000: return "> 1000 kcal";
            default: return "Todas";
        }
    }
    
    private void LimpiarFiltros()
    {
        filtroFechaString = string.Empty;
        filtroAlimentoId = 0;
        filtroCalorias = 0;
        alimentoSeleccionado = null;
        
        // Restaurar todos los registros
        consumosFiltrados = new List<RegistroConsumoDTO>(consumos);
        
        // Forzar actualizaci√≥n de la UI
        StateHasChanged();
    }
    
    private void EditarConsumo(int registroHabitoId)
    {
        Console.WriteLine($"üîó Navegando a editar consumo {registroHabitoId}");
        Navigation.NavigateTo($"/alimentos/editar/{registroHabitoId}");
    }
    
    private void IrARegistrarConsumo()
    {
        if (estudianteId > 0)
            Navigation.NavigateTo($"/alimentos/registrar/{estudianteId}");
        else
            Navigation.NavigateTo("/alimentos/registrar");
    }
}

<style>
    :root {
        --color-primary: #BCD09F;
        --color-secondary: #576E40;
        --color-dark: #221C04;
        --color-accent: #C2854C;
        --color-light: #F1EAC0;
    }
    
    .header-custom {
        background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-primary) 100%);
        color: white;
        border: none;
        padding: 1.5rem;
    }
    
    .btn-primary-custom {
        background-color: var(--color-primary);
        border-color: var(--color-primary);
        color: var(--color-dark);
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }
    
    .btn-primary-custom:hover {
        background-color: var(--color-secondary);
        border-color: var(--color-secondary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(87, 110, 64, 0.3);
    }
    
    .btn-warning-custom {
        background-color: var(--color-accent);
        border-color: var(--color-accent);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.5rem 1rem;
        border-radius: 6px;
    }
    
    .btn-warning-custom:hover {
        background-color: #a66f3d;
        border-color: #a66f3d;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(194, 133, 76, 0.4);
    }
    
    .btn-danger-custom {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
        font-weight: 500;
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        transition: all 0.3s ease;
    }
    
    .btn-danger-custom:hover {
        background-color: #c82333;
        border-color: #c82333;
        transform: scale(1.1);
    }
    
    .btn-secondary-custom {
        background-color: var(--color-secondary);
        border-color: var(--color-secondary);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
    }
    
    .btn-secondary-custom:hover {
        background-color: var(--color-primary);
        border-color: var(--color-primary);
        color: var(--color-dark);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(188, 208, 159, 0.3);
    }
    
    .btn-outline-custom {
        background-color: transparent;
        border-color: var(--color-secondary);
        color: var(--color-secondary);
        font-weight: 600;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .btn-outline-custom:hover {
        background-color: var(--color-secondary);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(87, 110, 64, 0.3);
    }
    
    .alert-info-custom {
        background-color: var(--color-light);
        border-color: var(--color-primary);
        color: var(--color-dark);
        border-left: 4px solid var(--color-primary);
        border-radius: 8px;
    }
    
    .alert-warning-custom {
        background-color: rgba(241, 234, 192, 0.3);
        border-color: var(--color-accent);
        color: var(--color-dark);
        border-left: 4px solid var(--color-accent);
        border-radius: 8px;
    }
    
    .alert-empty {
        background-color: rgba(188, 208, 159, 0.1);
        border: 2px dashed var(--color-primary);
        border-radius: 12px;
        padding: 2rem;
    }
    
    .filter-card {
        border: 2px solid var(--color-light);
        border-radius: 10px;
        background-color: rgba(241, 234, 192, 0.1);
    }
    
    .filter-header {
        background-color: var(--color-light);
        border-bottom: 2px solid var(--color-primary);
        color: var(--color-dark);
        font-weight: 600;
    }
    
    .badge-filter {
        background-color: var(--color-accent);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        margin-right: 0.5rem;
        display: inline-block;
        margin-top: 0.25rem;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
        border-left: 4px solid #dc3545;
        border-radius: 8px;
    }
    
    .table-custom {
        border-collapse: separate;
        border-spacing: 0 0.5rem;
    }
    
    .table-header-custom {
        background-color: var(--color-secondary);
        color: white;
    }
    
    .table-header-custom th {
        padding: 1rem;
        font-weight: 600;
        border: none;
        font-size: 1rem;
    }
    
    .table-row-custom {
        background-color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }
    
    .table-row-custom:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(188, 208, 159, 0.4);
    }
    
    .table-row-custom td {
        padding: 1rem;
        vertical-align: middle;
        border: none;
        background-color: white;
    }
    
    .fecha-cell {
        color: var(--color-secondary);
        font-size: 0.95rem;
    }
    
    .alimento-item {
        background-color: var(--color-light);
        border-left: 3px solid var(--color-primary);
        padding: 0.6rem 0.8rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .alimento-item:hover {
        background-color: var(--color-primary);
        border-left-color: var(--color-secondary);
    }
    
    .alimento-nombre {
        font-weight: 600;
        color: var(--color-dark);
        font-size: 0.95rem;
    }
    
    .alimento-detalle {
        font-size: 0.85rem;
        color: var(--color-secondary);
        margin-top: 0.2rem;
    }
    
    .badge-calorias {
        background-color: var(--color-accent);
        color: white;
        padding: 0.6rem 1.2rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 1rem;
        display: inline-block;
    }
    
    .form-label-custom {
        color: var(--color-secondary);
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .form-select-custom, .form-control-custom {
        border: 2px solid var(--color-light);
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 0.6rem;
    }
    
    .form-select-custom:focus, .form-control-custom:focus {
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0.3rem rgba(188, 208, 159, 0.25);
    }
</style>