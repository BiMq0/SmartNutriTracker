@using SmartNutriTracker.Front.Services
@using SmartNutriTracker.Front.Services.NotificacionesInternas
@using SmartNutriTracker.Shared.DTOs.Notificaciones
@using SmartNutriTracker.Shared.DTOs.NotificacionesLimite
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider authStateProvider
@inject NotificacionesLimiteService NotiService
@inject NotificacionesInternasService NotiInternasService
@rendermode InteractiveServer

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-dyM..." crossorigin="anonymous" referrerpolicy="no-referrer" />

@if (EsRolValido)
{
<div class="dropdown position-relative">

    <button class="btn btn-light border border-success rounded-circle dropdown-toggle position-relative"
            type="button"
            @onclick="ToggleDropdown">

        <i class="fas fa-bell text-success fs-4"></i>

        @if (ObtenerCantidadNotificaciones() > 0)
        {
            <span class="badge bg-success position-absolute top-0 start-100 translate-middle">
                @ObtenerCantidadNotificaciones()
            </span>
        }
    </button>

    <div class="dropdown-menu @((IsOpen ? "show" : "")) shadow-lg border border-success"
         style="width: 320px; right: 0; left: auto;">
        
        <div class="bg-success text-white fw-semibold p-3 rounded-top">
            @if (MostrarDiarias)
            {
                <span>Recordatorios Diarios</span>
            }
            else
            {
                <span>Alertas Nutricionales</span>
            }
        </div>

        @if (ObtenerCantidadNotificaciones() == 0)
        {
            <div class="p-4 text-center text-muted">
                No hay notificaciones por el momento.
            </div>
        }
        else
        {
            <ul class="list-group list-group-flush" style="max-height: 280px; overflow-y: auto;">
                @if (MostrarDiarias)
                {
                   
                    @if (NotificacionesDiarias != null)
                    {
                        <li class="list-group-item">
                            <p class="fw-bold text-success mb-1">@NotificacionesDiarias.NombreEstudiante</p>
                            <p class="small mb-1">@NotificacionesDiarias.Mensaje</p>
                            <p class="text-muted small" style="font-size: 0.8em;">@NotificacionesDiarias.FechaIntento.ToString("g")</p>
                        </li>
                    }
                    
                }
                else
                {
                    @foreach (var alerta in Alertas)
                    {
                        <li class="list-group-item">
                            <p class="fw-bold text-success mb-1">@alerta.NombreEstudiante</p>
                            <p class="small mb-1">@alerta.Mensaje</p>
                            <p class="text-success small">Exceso: <strong>@alerta.Exceso kcal</strong></p>
                        </li>
                    }
                }
            </ul>
        }
    </div>
</div>
}

@code {
    private bool IsOpen = false;
    private bool MostrarDiarias = true; 
    private string? debugRol;
    private List<NotificacionesAlertaNutricionalDTO> Alertas = new();
    private NotificacionDiariaDTO? NotificacionesDiarias; // Allow null

    private bool EsRolValido = false;

    private HubConnection? hubConnection;

    protected override async Task OnInitializedAsync()
    {
        var authState = await authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity is not null && user.Identity.IsAuthenticated)
        {
            var rol = user.FindFirst(c => c.Type == "role" || c.Type == ClaimTypes.Role)?.Value;
            debugRol = rol;
            Console.WriteLine("Rol: " + rol);
            if (rol == "3")
            {
                MostrarDiarias = true;
                EsRolValido = true;
            }
            else if (rol == "2") 
            {
                MostrarDiarias = false;
                EsRolValido = true;
            }

            if (EsRolValido && rol != null)
            {
                try
                {
                    hubConnection = new HubConnectionBuilder()
                        .WithUrl(NavigationManager.ToAbsoluteUri("/notificacionHub"))
                        .WithAutomaticReconnect()
                        .Build();

                    hubConnection.On("RecibirNotificacion", async () =>
                    {
                        await CargarDatos();
                        await InvokeAsync(StateHasChanged);
                    });

                    await hubConnection.StartAsync();
                    await hubConnection.SendAsync("UnirseAGrupo", rol);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error conectando a SignalR: {ex.Message}");
                }
            }
        }

        if (EsRolValido)
        {
            await CargarDatos();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private async Task CargarDatos()
    {
        if (MostrarDiarias)
        {
            NotificacionesDiarias = await NotiInternasService.ObtenerNotificacionPorEstudianteAsync(1);
        }
        else
        {
            Alertas = await NotiService.ObtenerAlertasAsync();
        }
    }

    private int ObtenerCantidadNotificaciones()
    {
        return MostrarDiarias ? ((NotificacionesDiarias != null) ? 1 : 0) : Alertas.Count;
    }

    private void ToggleDropdown()
    {
        IsOpen = !IsOpen;
    }
}
